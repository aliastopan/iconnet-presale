@page "/helpdesk"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.SignalR
@using Microsoft.AspNetCore.SignalR.Client
@using IConnet.Presale.Domain.Aggregates.Presales
@using IConnet.Presale.Domain.Enums
@using IConnet.Presale.WebApp.Services

@inject IWorkloadManager _workloadManager
@inject IDialogService _dialogService
@inject BroadcastService _broadcastService

<PageTitle>Helpdesk</PageTitle>

<FluentLabel Typo="Typography.H3" MarginBlock="0.5rem">Helpdesk</FluentLabel>

<div class="datagrid-wrapper">
    @if (_workPapers is not null)
    {
        <FluentDataGrid Items="@_workPapers"
            TGridItem="WorkPaper"
            Virtualize="true"
            Pagination="@_pagination"
            ItemSize="32"
            OnRowFocus="@OnRowSelected"
            EmptyContent="@HtmlFragment.EmptyContent">

            <TemplateColumn Title="ID PERMOHONAN" SortBy="@sortByIdPermohonan">
                <div class="">
                    @context.ApprovalOpportunity.IdPermohonan
                </div>
            </TemplateColumn>
            <TemplateColumn Title="PIC CHAT/CALL">
                <div class="">
                    @if (string.IsNullOrEmpty(context.HelpdeskInCharge.Alias))
                    {
                        <span>Menunggu Klaim</span>
                    }
                    else
                    {
                        @context.HelpdeskInCharge.Alias
                    }
                </div>
            </TemplateColumn>
            <TemplateColumn Title="SHIFT">
                <div class="">
                    @context.Shift
                </div>
            </TemplateColumn>
            <TemplateColumn Title="TGL CHAT/CALL HELPDESK">
                <div class="">
                    @context.ProsesValidasi.ChatCallMulai.TglAksi
                </div>
            </TemplateColumn>
            <TemplateColumn Title="NAMA PELANGGAN">
                <div class="">
                    @context.ProsesValidasi.ParameterValidasi.NamaPelanggan
                </div>
            </TemplateColumn>
            <TemplateColumn Title="NOMOR TELP AKTIF">
                <div class="">
                    @context.ProsesValidasi.ParameterValidasi.NomorTelepon
                </div>
            </TemplateColumn>
            <TemplateColumn Title="EMAIL AKTIF">
                <div class="">
                    @context.ProsesValidasi.ParameterValidasi.Email
                </div>
            </TemplateColumn>
            <TemplateColumn Title="ALAMAT PELANGGAN">
                <div class="">
                    @context.ProsesValidasi.ParameterValidasi.AlamatPelanggan
                </div>
            </TemplateColumn>
            <TemplateColumn Title="ID PLAN">
                <div class="">
                    @context.ProsesValidasi.ParameterValidasi.PlnId
                </div>
            </TemplateColumn>
            <TemplateColumn Title="SHARE LOC">
                <div class="">
                    @context.ProsesValidasi.ParameterValidasi.ShareLoc.LatitudeLongitude
                </div>
            </TemplateColumn>
            <TemplateColumn Title="TGL CHAT/CALL DIJAWAB">
                <div class="">
                    @context.ProsesValidasi.ChatCallRespons.TglAksi
                </div>
            </TemplateColumn>
            <TemplateColumn Title="REKAP CHAT HISTORY">
                <div class="">
                    @context.ProsesValidasi.LinkRecapChatHistory
                </div>
            </TemplateColumn>
            <TemplateColumn Title="STATUS VALIDASI">
                <div class="">
                    @context.ProsesValidasi.StatusValidasi
                </div>
            </TemplateColumn>
            <TemplateColumn Title="KETERANGAN VALIDASI">
                <div class="">
                    @context.ProsesValidasi.StatusValidasi
                </div>
            </TemplateColumn>
            <TemplateColumn Title="CONTACT WHATSAPP">
                <div class="">
                    @{
                        var url = $"http://{context.ApprovalOpportunity.Pemohon.WhatsApp}";
                    }
                    <FluentAnchor Href="@url" Target="_blank" Appearance="Appearance.Lightweight">
                        @context.ApprovalOpportunity.Pemohon.WhatsApp
                    </FluentAnchor>
                </div>
            </TemplateColumn>
        </FluentDataGrid>
    }
    else
    {
        <span>Loading...</span>
    }
</div>

<FluentPaginator State="@_pagination">
    <SummaryTemplate>
        Terdapat <strong>@(_pagination.TotalItemCount ?? 0)</strong> baris
    </SummaryTemplate>
    <PaginationTextTemplate>
        Halaman <strong>@(_pagination.CurrentPageIndex + 1)</strong> dari <strong>@(_pagination.LastPageIndex + 1)</strong> halaman
    </PaginationTextTemplate>
</FluentPaginator>

@code
{
    private const int _itemPerPage = 10;
    private PaginationState _pagination = new PaginationState { ItemsPerPage = _itemPerPage };

    private IQueryable<WorkPaper>? _workPapers;

    GridSort<WorkPaper> sortByIdPermohonan = GridSort<WorkPaper>
        .ByAscending(workPaper => workPaper.ApprovalOpportunity.IdPermohonan);

    protected override async Task OnInitializedAsync()
    {
        List<WorkPaper> workload = await _workloadManager.FetchWorkloadAsync(CacheFetchMode.OnlyImportVerified);
        _workPapers = workload.AsQueryable();

        _broadcastService.Subscribe(OnUpdateWorkloadAsync);
    }

    private async Task OnUpdateWorkloadAsync(string message)
    {
        List<WorkPaper> workload = await _workloadManager.FetchWorkloadAsync(CacheFetchMode.OnlyImportVerified);
        _workPapers = workload.AsQueryable();

        Log.Warning(message);

        // ensure component update is handle by UI thread
        await InvokeAsync(() =>
        {
            StateHasChanged();
            Log.Warning("Re-render 'Helpdesk Page'.");
        });
    }

    private async Task OnRowSelected(FluentDataGridRow<WorkPaper> row)
    {
        if (row.Item is not null)
        {
            var workPaper = row.Item;
            Log.Warning("Selected row {0}", workPaper is null ? "null" : workPaper.ApprovalOpportunity.IdPermohonan);

            await OpenDialogAsync(row.Item);
        }
    }

    private async Task OpenDialogAsync(WorkPaper workPaper)
    {
        var parameters = new DialogParameters()
        {
            Title = "Klaim Workload",
            TrapFocus = true,
            Width = "500px",
        };

        var dialog = await _dialogService.ShowDialogAsync<WorkloadStagingDialog>(workPaper, parameters);
        var result = await dialog.Result;

        if (!result.Cancelled && result.Data != null)
        {
            var dialoagData = (WorkPaper)result.Data;
            await ClaimWorkloadAsync(dialoagData);
        }
    }

    private async Task ClaimWorkloadAsync(WorkPaper workPaper)
    {
        await _workloadManager.UpdateWorkloadAsync(workPaper);

        var message = $"{workPaper.HelpdeskInCharge.Alias} has claimed '{workPaper.ApprovalOpportunity.IdPermohonan}'";
        await _broadcastService.BroadcastMessageAsync(message);
    }
}